# 4. 总结

## 4.1 所做工作概述
本次报告主要进行了 Openswan 的任务描述，并进行了架构分析，对性能测试及遇到的阻碍进行复现，并对整个流程中遇到的客观问题进行瓶颈分析。
所做工作大致涵盖：
前期工作：从官网了解 Openswan 、去GitHub上 克隆源码、选择合适的编译器、适合的调试方式。
中期工作：大致分析框架，后主要进行性能测试，在性能测试的过程中同步进行架构、瓶颈分析；
		寻找合适的测试方式和测试方向，对基本环境进行配置。
后期工作：进行了 Windows 作为 Responser 的测试，后发现确实行不通，摒弃；
		进行 Ubuntu 自身回环测试，先在原有配置上更改，后改为独立命名空间，在任务进行过程中不断发现问题，解决问题，再发现问题。

## 4.2 个人收获
### 和项目直接相关的
1. nat_xxxxx=yes/no情况
2. veth0 和 veth1 本质上可以随意添加和删除，因为它们是内核虚拟接口，不写入系统配置，不会永久保存；
   但前提是没有将它配置为路由接口或绑定为SSH、DNS、网关等关键服务。
   否则很可能会导致远程SSH不可用，DNS不可用，所有 `systemd-networkd` 管理的网络出错。
3. veth0 和 veth1 是一对虚拟接口，绑定在一起。删除任意一端（如 veth0）会自动连带删除另一端（veth1）
   它们不属于系统网卡，也不会写入 `/etc/netplan`、`/etc/network/interfaces` 或 systemd 的网络配置
4. screen / tmux”的意义：
   在 SSH 测试时，有两种情况会导致中断：

   - 断网（意外）
   - 重启服务（如 `ipsec restart` 时）

    `screen` / `tmux` 可以：

   - 创建 **持久的 Shell 会话**
   - 即使 SSH 断开，也不会关闭任务

    示例：
	```
	sudo apt install tmux
	tmux new -s testvpn
	# 在新窗口中执行所有命令

	# 如果断开了
	tmux attach -t testvpn
	```
5. 不要设置特定的监听接口，否则肯定会监听不到所有字段。
	在本项目中表现为 pluto 监听不到 UDP 500 端口，ipsec网络接口绑定失败：
	![](https://cdn.nlark.com/yuque/0/2025/png/40589972/1744719809036-c5fa181d-466d-461e-b1b0-d7a439c87723.png)
6. 静态IP在网络连接上有一定问题，脚本也行不通。一旦执行，无线网就会断开


---

### 个人学到的知识小点

1. 了解了IPsec、封装安全载荷、X11转发等基础性概念。
2. 了解到OpenWrt，服务器公网和私网地址的区别。公网是可以从服务器访问的IP地址，私网是仅在同一个局域网（或云服务器内网）中使用的地址。
3. 了解到了C/C++的不同文件后缀名。Openswan框架体系较大，用的文件、后缀名也多，借此了解到了除.cpp，.h之外的其他后缀名，如.c,.in,.pc,.hpp,.cxx,.patch,.o,.a等等其他后缀名及其他含义。
4. 了解了NAT，即内网地址转换的含义；以及NAT在IPsec中的问题。NAT会改变IP地址和端口号，导致身份验证失败，所以IPsec和NAT不兼容或需特殊处理。
5. 对Linux系统的了解更深一步。
	通过实际应用加深了对Linux用户权限体系的理解；
		常见Linux命令
6. 只能有一个叫 `test` 的 `conn`，但是可以写任意多个连接块，只要名字不重复即可。
7. 学习了 Linux 用户权限体系，了解`root` 用户、普通 `user` 用户以及 `sudo` 命令在权限控制中各自作用。
8. 避免 OS 层不可控逻辑，Windows 自带 IPsec 有太多黑盒，无法查看或控制其内部实现逻辑，只能看到输入和输出，过程是封闭和不透明的。
9. 网关指一个网络的出口，所有非本网段 IP 的访问请求都会发给它。绑定网关指用户手动或自动给某个接口配置了默认网关，比如 `ip route add default via 10.1.218.1`。如果 veth0 或 veth1 绑定了网关，会改变系统默认的路由，可能导致 主机上网失败、连接混乱、打乱测试数据。
10. veth 是一个虚拟的以太接口，在 linux 中的 veth 和普通网卡是一样对待的。veth 总是成对出现的，被称为 veth pair。
11. `netns` 是 Linux 的网络命名空间。允许用户创建多个“隔离的网络环境”，每个环境有自己独立的：
    - 网络接口（如 `eth0`、`veth0` 等）
    - 路由表
    - 防火墙规则
    - IP 地址配置

    `ip netns` 创建的是 虚拟的小网络环境，互相完全隔离，就像多个“小电脑”共用一个系统。
  12. config 参数：通常用于指定配置文件的路径，允许用户在启动程序时提供不同的配置
  13. Linux输入法中文状态下的数字和英文状态下的数字不一样。在XShell直接编辑配置中，不能用鼠标滚轮上下滑动或者触摸屏上下滑动，否则会出现乱码；VScode可以。VScode相对用户更友好一点。
  14. `virtual_private` 定义了哪些私有 IP 地址段是允许 NAT 穿越的范围（NAT-Traversal）。在开启 `nat_traversal=yes` 时，这个字段决定哪些私网流量允许被封装进 UDP（4500端口）发出去。
  15. sudo chmod 600 /etc/ipsec.secrets:
	  6：拥有者权限=可读（4）+可写（2）
	  0：用户组织权限=无
	  0：其他人权限=无
  16. 了解了IPsec支持的有效命令
  17. 学习了常见的md语言标签选择
  18. 大致了解到一些和 Docker 、Kubernetes 容器相关的东西















