# 1. Openswan 架构分析

## 1.1 总体架构

**Openswan 的架构主要由以下几个核心模块组成：**

---

### 1. Pluto（用户态 IKE 引擎）

Pluto 是 Openswan 的核心组件，负责 IKE 协议的实现与策略控制，涵盖密钥协商、身份认证、安全关联（SA）管理等任务。

> Pluto 是用户态核心进程，负责与内核态通信，建立安全策略和 IPsec 隧道。

#### Pluto 子模块结构：

| 子模块 | 功能说明 |
|--------|----------|
| `main.c / pluto.c` | Pluto 主循环，负责监听 socket、接收命令、调度状态机 |
| `connections.c` | 管理与解析 `ipsec.conf` 中定义的连接配置 |
| `state.c / statemachine.c` | IKE 状态机核心逻辑，驱动协商流程 |
| `packet.c / demux.c` | 报文解析与封装，将接收的报文分发到对应状态机 |
| `log.c / debug.c` | 日志系统与调试输出控制 |
| `secrets.c` | 加载与处理 `ipsec.secrets` 中的密钥、证书等认证材料 |
| `kernel_netlink.c / kernel_spi.c` | 通过 Netlink / PF_KEY 与内核通信，管理 SAs 和策略 |
| `whack.c / whacklib.c` | 命令接口模块，支持 `ipsec whack` 工具与 Pluto 通信 |

---

### 2. Libipsec（策略与加解密接口）

Libipsec 提供对加密算法的支持，负责 IPsec 策略的构建与管理，是 Pluto 和内核数据通道之间的桥梁。

> 它帮助 Openswan 正确地设置 ESP/AH 协议参数，并确保加解密过程符号一致性。

---

### 3. 内核态 IPsec 协议栈（Netkey / XFRM）

Openswan 不直接实现数据加解密，而是依赖 Linux 内核的 IPsec 协议栈，完成实际隧道数据的封装与保护。

| 子系统 | 功能说明 |
|--------|----------|
| **XFRM** 子系统 | Linux 内核内建的 IPsec 框架，支持 ESP/AH 协议，通过 Netlink 接收 Pluto 下发的策略与 SA |
| **Netkey** | 默认启用的 IPsec 协议栈，基于 XFRM 构建，提供高兼容性和性能，Openswan 默认支持该模式 |
| **KLIPS**（可选） | Openswan 早期提供的内核模块，是一个备用选项（可选组件），可用于兼容旧系统或抓包调试，但现已不推荐默认使用 |

---

### 4. 配置系统（用户配置接口）

Openswan 的运行依赖两个关键配置文件：

- `ipsec.conf`：用于定义连接参数，如 `left`、`right`、认证方式、加密算法等。
- `ipsec.secrets`：用于存储密钥、PSK、证书等认证信息。

---

### 5. 其他组件

- **lib/**：包含公共头文件与函数库，供 Pluto、Whack 等模块复用。
- **programs/**：包含 Openswan 提供的用户工具（如 `ipsec`, `whack`, 测试脚本等）。
- **testing/**：包含自动化测试脚本和测试场景配置。
- **packaging/**：用于不同平台的打包、安装脚本与配置。

---

从整体上看，Openswan 采用了 **“用户态控制 + 内核态执行”** 的架构，将协议协商与策略控制放在用户空间（Pluto），而数据加密和转发由内核空间完成（Netkey/XFRM），从而实现了高安全性与高性能的结合。


## 1.2 优缺点分析

---

### ***优点***：

#### 1. 用户态与内核态分离设计

- **优势**：
    
    - 协议控制（IKE）与数据处理（IPsec加解密）职责清晰，互不干扰。
        
    - 用户态（Pluto）可灵活更新与维护，内核态（Netkey/XFRM）则保证高性能、稳定性。
        
- **实际效果**：
    
    - 保持了高安全性（用户态可快速修补漏洞）与高性能（内核直接转发数据包）。
        

---

#### 2. 核心模块划分清晰、功能独立

- **优势**：
    
    - Pluto 作为主进程，子模块（如 `state.c`、`connections.c`、`packet.c`）各司其职，代码结构逻辑性强。
        
    - `libipsec`、`whack`、`testing` 等各自独立，便于单独编译、测试和扩展。
        
- **实际效果**：
    
    - 开发者可以快速定位问题，如连接管理问题看 `connections.c`，状态处理问题看 `statemachine.c`。
        

---

#### 3. 高兼容性与灵活性

- **优势**：
    
    - 支持多种内核 IPsec 栈（Netkey、KLIPS、XFRM），适应不同环境。
        
    - 通过标准接口（如 Netlink）与 Linux 内核交互，兼容性好。
        
- **实际效果**：
    
    - 可部署在多版本 Linux 发行版上，适应性强（服务器、嵌入式设备均可）。
        

---

#### 4. 配置系统与脚本化支持强大

- **优势**：
    
    - 使用 `ipsec.conf` / `ipsec.secrets` 统一配置，简洁明了。
        
    - 提供丰富的工具（如 `ipsec` 命令、`whack` 控制接口），支持脚本式批量管理和自动化测试。
        
- **实际效果**：
    
    - 运维友好，适合大规模部署与集中管理。
        

---

### ***缺点***：

#### 1. Pluto 是守护进程，调试复杂度高

- **问题**：
    
    - 由于 Pluto 以系统服务（daemon）方式运行，无法直接在 IDE（如 VSCode）“一键启动调试”。
        
- **实际影响**：
    
    - 必须手动启动 Pluto 后，再通过附加进程方式调试，增加了开发调试门槛。
        

---

#### 2. 代码历史较长，部分模块风格陈旧

- **问题**：
    
    - 由于源代码延续自 FreeS/WAN 项目，某些模块（如 `kernel_spi.c`）风格偏 C89，宏定义、指针操作繁杂。
    - Openswan 的文档在某些方面较为缺乏，特别是对于某些复杂的配置项和高级功能，官方文档维护不够活跃。与此同时，Openswan 的社区支持较为分散，可能需要更多的开发者参与到其维护和更新中。
        
- **实际影响**：
    
    - 阅读和维护成本较高。
        

---

#### 3. 对新协议标准（如 IKEv2）支持较弱

- **问题**：
    
    - Openswan 主要实现 IKEv1，虽然有补丁扩展，但原生对 IKEv2 支持不完整（需转向 libreswan、strongSwan）。
        
- **实际影响**：
    
    - 在需要现代 VPN 特性（如 MOBIKE、多主机）场景下使用受限。
        

---

#### 4. KLIPS 模块维护较弱

- **问题**：
    
    - KLIPS 作为 Openswan 早期自带内核模块，近年来缺乏活跃维护，与新内核版本兼容性下降。
        
- **实际影响**：
    
    - 虽然仍然可选，但实际使用场景越来越少。
        

---

#### 5. 自动测试与 CI 支持不完善

- **问题**：
    
    - 尽管 `testing/` 目录提供了一些脚本，但整体测试覆盖率有限，缺乏现代化的持续集成（CI）体系。
        
- **实际影响**：
    
    - 需要依赖人工测试或自行搭建测试环境，增加了回归验证成本。

---

#### 6. 模块耦合度高

- **问题**：
    
    - 尽管 Openswan 的架构是模块化的，但各模块之间的耦合度较高，特别是 Pluto 和内核模块之间的关系紧密。这种耦合可能导致在进行扩展或修改时较为复杂。
        

---

#### 7. 可扩展性弱

- **问题**：
    
    - Openswan 的核心架构虽然支持基本的 VPN 功能，但对于高度定制化或大规模部署场景的支持较为有限。例如，扩展新的加密算法或集成第三方模块可能需要较高的开发投入。