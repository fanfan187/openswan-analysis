# 3. 性能瓶颈分析

## 3.1 性能瓶颈

（由于未能完整的进行协商测试，所以下面仅摘录了部分在测试过程中认为是瓶颈的问题）
在进行`OpenSwan`分析时，发现了以下问题：

1. **Pluto 启动后无法从我的本地接口中匹配 `left=` 或 `right=` 的 IP**：  
    某次错误日志：
    
    ```log
    <27>Apr 22 22:41:14 ipsec setup: interface `vetha'
	```
    
    Openswan 的版本和 `interfaces=...` 的配置方式不兼容。仍在使用 `interface=%default` 或 `interface="ipsec0=eth0"` 风格。源码版本不稳定，不支持这种现代配置的方式。
    
    
1. **Openswan 实现上的缺陷：pluto 的锁文件路径是全局固定的**：  
    Openswan（pluto）在启动时会默认在 `/var/run/pluto/pluto.pid` 写入进程 ID，即使使用的是 **不同的网络命名空间**，该路径仍然指向的是宿主文件系统上的同一个路径。两个实例试图同时写入这个文件会发生冲突。
    
    由于缺乏“基于命名空间隔离的 PID 文件路径”机制，多个实例之间容易发生冲突，影响系统稳定性。且Openswan 并不太适合容器化和命名空间并发架构。
    
2. **Openswan `pluto` 不支持 `--config` 参数**：  
    我的 Openswan 版本不支持 `--config` 参数（后经查阅发现我用的是发开版本，不稳定，有可能有残缺或实现不完善的问题）。没有 `--config` 支持，给配置管理带来一定不便，尤其是在多环境部署和自动化测试时。
3. **算法注册失败（kernel alg add fails）**

- 日志提示：
    
```log
kernel alg add(3,14,251) fails because alg combo is invalid 
kernel alg add(3,14,8) fails because alg combo is invalid
```
- 说明 Openswan 向内核请求注册算法组合失败，可能是因为内核版本或编译选项不支持对应加密算法。
5. **`pluto` 单线程限制**

- `pluto` 是单线程模型，所有连接协商和维护操作由单一事件循环处理。
    
- 导致在多核 CPU 上无法充分利用计算资源。
6. **初期配置不合理**

- 默认使用了较复杂加密算法（如 AES256+SHA512+MODP2048）。
    
- 重协商参数设置较为保守，导致频繁的 SA 重协商，影响整体性能。
---

## 3.2 改进方案

1. **Openswan （某些版本）缺乏 `--config` 支持的缺陷**： 
    **改进建议**：
    
    - **支持 `--config` 参数**：增强配置灵活性，方便用户在不同环境中进行灵活配置。
        
    - **多环境支持**：提供内置配置管理工具或命令行参数，便于管理不同环境设置。
        
    **总结**：虽然 `--config` 参数在用例中不算致命缺陷，但在现代使用场景中确实影响了灵活性和操作便捷性。其他 VPN 实现通常提供了该支持，增强 Openswan 配置灵活性是一个潜在的改进方向。
    
2. **Openswan 低层网络服务与系统协作的特性**：
    
    - Openswan 是低层网络服务（IPsec 实现），和内核网络栈、NETKEY/XFRM 等系统组件密切协作，必须在系统层面启动，不能像普通应用程序那样直接运行。
        
    - **建议改进**：提供一个“前台运行 + 禁用 daemon 模式 + 开启调试端口”的开发者模式，有助于提高开发体验。
    
3. **针对算法注册失败**

- 查看 `/proc/crypto`，确认内核支持的算法。
    
- 加载必要的内核模块（如 `modprobe aes_generic`、`modprobe sha256_generic`）。
    
- 在 `ipsec.conf` 中使用更广泛支持的算法组合，例如：
    
```bash
ike=aes128-sha1;modp1024 esp=aes128-sha1
```

5. **针对 `pluto` 单线程限制**

- 启动多个 Openswan 实例，在不同的网络接口或端口上监听。
    
- 通过负载均衡（如 IPVS、LVS）分流请求到不同实例。
    
- 或者中长期考虑迁移到 StrongSwan/Libreswan，它们支持多线程/多核优化。


6. **针对初期配置不合理**

- 规范加密算法选择，使用兼顾安全性和性能的组合。
    
- 统一连接模板，减少特殊配置。
    
- 示例标准连接模板：